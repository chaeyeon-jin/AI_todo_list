<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React to-do app</title>
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dongle&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-blue-50">
    <div id="root"></div>
    <script type="text/babel">
      const API_URL = 'http://localhost:3002/api/todos';
      
      // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
      // âš ï¸ ë³¸ì¸ì˜ Supabase í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
      const SUPABASE_URL = 'https://cjzpkqkqvpddcrmljjcc.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqenBrcWtxdnBkZGNybWxqamNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjg3NjAsImV4cCI6MjA3NTk0NDc2MH0.HE_Qt747kNXcU29lES-ZEfPOeMQerWE-VucBlYw6CXU';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ë¡œê·¸ì¸/íšŒì›ê°€ì… ì»´í¬ë„ŒíŠ¸
      function AuthSection({ onAuthSuccess }) {
        const [isLogin, setIsLogin] = React.useState(true);
        const [email, setEmail] = React.useState('');
        const [password, setPassword] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [message, setMessage] = React.useState('');

        // íšŒì›ê°€ì…: supabase.auth.signUp()
        const handleSignUp = async (e) => {
          e.preventDefault();
          setLoading(true);
          setMessage('');

          try {
            const { data, error } = await supabase.auth.signUp({
              email: email,
              password: password
            });

            if (error) {
              setMessage('âŒ ' + error.message);
            } else {
              if (data.user && !data.session) {
                setMessage('âœ… ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
              } else if (data.session) {
                setMessage('âœ… íšŒì›ê°€ì… ì„±ê³µ!');
                onAuthSuccess(data.user);
              } else {
                setMessage('âœ… íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                setIsLogin(true);
              }
            }
          } catch (err) {
            console.error('Supabase ì—°ê²° ì—ëŸ¬:', err);
            setMessage('âŒ Supabase ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. Supabase Dashboardì—ì„œ í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸\n2. Project URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n3. í”„ë¡œì íŠ¸ ìƒì„± í›„ 2-3ë¶„ ëŒ€ê¸°');
          } finally {
            setLoading(false);
          }
        };

        // ë¡œê·¸ì¸: supabase.auth.signInWithPassword()
        const handleSignIn = async (e) => {
          e.preventDefault();
          setLoading(true);
          setMessage('');

          try {
            const { data, error } = await supabase.auth.signInWithPassword({
              email: email,
              password: password
            });

            if (error) {
              setMessage('âŒ ' + error.message);
            } else {
              setMessage('âœ… ë¡œê·¸ì¸ ì„±ê³µ!');
              onAuthSuccess(data.user);
            }
          } catch (err) {
            console.error('Supabase ì—°ê²° ì—ëŸ¬:', err);
            setMessage('âŒ Supabase ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. Supabase Dashboardì—ì„œ í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸\n2. Project URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n3. í”„ë¡œì íŠ¸ ìƒì„± í›„ 2-3ë¶„ ëŒ€ê¸°');
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="font-[Dongle] max-w-md mx-auto mt-8 p-8 bg-white rounded-lg shadow-lg border border-blue-200">
            <h2 className="text-3xl md:text-6xl text-blue-400 mb-6 text-center font-bold">
              {isLogin ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…'}
            </h2>
            
            <form onSubmit={isLogin ? handleSignIn : handleSignUp}>
              <div className="mb-4">
                <label className="block text-2xl mb-2 text-gray-700 font-medium">ì´ë©”ì¼</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full text-xl px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="user@example.com"
                />
              </div>

              <div className="mb-6">
                <label className="block text-2xl mb-2 text-gray-700 font-medium">ë¹„ë°€ë²ˆí˜¸</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength="6"
                  className="w-full text-xl px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="ìµœì†Œ 6ì ì´ìƒ"
                />
              </div>

              {message && (
                <div className={`mb-4 p-3 rounded-lg text-lg ${
                  message.startsWith('âœ…') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                }`}>
                  {message}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className={`w-full text-xl py-3 rounded-lg font-medium transition-colors ${
                  loading 
                    ? 'bg-gray-400 cursor-not-allowed' 
                    : 'bg-blue-400 hover:bg-blue-500 text-white'
                }`}
              >
                {loading ? 'ì²˜ë¦¬ ì¤‘...' : (isLogin ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…')}
              </button>
            </form>

            <div className="mt-4 text-center">
              <button
                onClick={() => {
                  setIsLogin(!isLogin);
                  setMessage('');
                  setEmail('');
                  setPassword('');
                }}
                className="text-blue-500 hover:text-blue-700 text-lg"
              >
                {isLogin ? 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…' : 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸'}
              </button>
            </div>

            
          </div>
        );
      }

      function AIPlanningSection({ onAddMultipleTodos }) {
        const [goalText, setGoalText] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [generatedTodos, setGeneratedTodos] = React.useState([]);
        const [selectedTodos, setSelectedTodos] = React.useState([]);
        const [error, setError] = React.useState('');

        const handleGenerateTodos = async () => {
          if (!goalText || goalText.trim() === '') {
            alert('ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
          }

          setLoading(true);
          setError('');
          setGeneratedTodos([]);

          try {
            // ë°±ì—”ë“œ AI API í˜¸ì¶œ
            const response = await fetch('http://localhost:3002/api/ai/generate-todos', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ goal: goalText.trim() })
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
              throw new Error(data.error || 'AI ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            console.log('âœ… AI ìƒì„± ì™„ë£Œ:', data.todos);
            setGeneratedTodos(data.todos);
            setSelectedTodos([]); // ì„ íƒ ì´ˆê¸°í™”
          } catch (err) {
            setError(err.message || 'AI ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error('AI ìš”ì²­ ì—ëŸ¬:', err);
          } finally {
            setLoading(false);
          }
        };

        const toggleTodoSelection = (index) => {
          if (selectedTodos.includes(index)) {
            setSelectedTodos(selectedTodos.filter(i => i !== index));
          } else {
            setSelectedTodos([...selectedTodos, index]);
          }
        };

        const handleAddSelectedTodos = () => {
          if (selectedTodos.length === 0) {
            alert('ì¶”ê°€í•  í• ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
          }
          
          const todosToAdd = selectedTodos
            .sort((a, b) => a - b) // ìˆœì„œëŒ€ë¡œ ì •ë ¬
            .map(index => generatedTodos[index]);
          
          onAddMultipleTodos(todosToAdd);
          setGeneratedTodos([]);
          setSelectedTodos([]);
          setGoalText('');
          alert(`${todosToAdd.length}ê°œì˜ í• ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        };

        const handleAddAllTodos = () => {
          if (generatedTodos.length === 0) return;
          onAddMultipleTodos(generatedTodos);
          setGeneratedTodos([]);
          setSelectedTodos([]);
          setGoalText('');
          alert(`${generatedTodos.length}ê°œì˜ í• ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        };

        return (
          <div className="border border-purple-200 bg-purple-100 rounded-lg p-6 mb-6">
            <h2 className="text-2xl md:text-3xl text-purple-600 mb-4 text-center font-bold">
              ğŸ¤– AIë¡œ ê³„íš ì„¸ìš°ê¸°
            </h2>
            <p className="text-lg md:text-xl text-gray-600 mb-4 text-center">
              í° ëª©í‘œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ê³„ë¡œ ìª¼ê°œë“œë¦½ë‹ˆë‹¤
            </p>
            
            <div className="space-y-4">
              <textarea
                value={goalText}
                onChange={(e) => setGoalText(e.target.value)}
                placeholder="ì˜ˆ: 'ì›¹ ê°œë°œ ê³µë¶€í•˜ê¸°', 'ê±´ê°•í•œ ìƒí™œìŠµê´€ ë§Œë“¤ê¸°', 'í”„ë¡œì íŠ¸ ì™„ì„±í•˜ê¸°' ë“±"
                className="w-full text-xl md:text-2xl px-4 py-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none resize-none"
                rows="3"
              />
              
              <div className="flex gap-2">
                <button
                  onClick={handleGenerateTodos}
                  disabled={loading || !goalText.trim()}
                  className={`flex-1 text-xl md:text-2xl py-3 rounded-lg font-medium transition-colors ${
                    loading || !goalText.trim()
                      ? 'bg-gray-200 cursor-not-allowed'
                      : 'bg-purple-500 hover:bg-purple-600 text-white'
                  }`}
                >
                  {loading ? 'ğŸ¤– AIê°€ ìƒê°ì¤‘...' : 'âœ¨ AIë¡œ ìª¼ê°œê¸°'}
                </button>
              </div>

              {error && (
                <div className="p-3 bg-red-100 text-red-700 rounded-lg text-lg">
                  {error}
                </div>
              )}

              {generatedTodos.length > 0 && (
                <div className="mt-4 p-4 bg-white rounded-lg border border-purple-200">
                  <div className="flex justify-between items-center mb-3">
                    <h3 className="text-xl md:text-2xl font-semibold text-gray-800">
                      ğŸ“Œ ìƒì„±ëœ í• ì¼ ëª©ë¡ ({generatedTodos.length}ê°œ)
                    </h3>
                    <div className="flex gap-2">
                      <button
                        onClick={handleAddSelectedTodos}
                        disabled={selectedTodos.length === 0}
                        className={`px-4 py-2 rounded-lg text-lg md:text-xl transition-colors ${
                          selectedTodos.length === 0
                            ? 'bg-gray-300 cursor-not-allowed text-gray-500'
                            : 'bg-blue-500 hover:bg-blue-600 text-white'
                        }`}
                      >
                        ì„ íƒ ì¶”ê°€ ({selectedTodos.length})
                      </button>
                      <button
                        onClick={handleAddAllTodos}
                        className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-lg md:text-xl transition-colors"
                      >
                        ì „ì²´ ì¶”ê°€ â†’
                      </button>
                    </div>
                  </div>
                  <ul className="space-y-2">
                    {generatedTodos.map((todo, index) => (
                      <li
                        key={index}
                        className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${
                          selectedTodos.includes(index)
                            ? 'bg-purple-100 border-2 border-purple-400'
                            : 'bg-purple-50 border-2 border-transparent hover:bg-purple-100'
                        }`}
                        onClick={() => toggleTodoSelection(index)}
                      >
                        <input
                          type="checkbox"
                          checked={selectedTodos.includes(index)}
                          onChange={() => toggleTodoSelection(index)}
                          className="w-5 h-5 text-purple-600 cursor-pointer"
                          onClick={(e) => e.stopPropagation()}
                        />
                        <span className="text-purple-600 font-bold text-xl">
                          {index + 1}.
                        </span>
                        <span className="text-gray-700 text-xl flex-1">
                          {todo}
                        </span>
                      </li>
                    ))}
                  </ul>
                  <p className="text-sm md:text-base text-gray-500 mt-3 text-center">
                    ğŸ’¡ í´ë¦­í•˜ê±°ë‚˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ì—¬ ì›í•˜ëŠ” í• ì¼ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                  </p>
                </div>
              )}
            </div>
          </div>
        );
      }

      function AddTodoSection({
        setInputText,
        inputText,
        addTodo,
        activeEnter,
      }) {
        return (
          <div className="border border-blue-200 bg-white rounded-lg p-6 mb-6 text-center">
            <h2 className="text-2xl md:text-3xl text-gray-800 mb-4">í• ì¼ ì¶”ê°€í•˜ê¸°</h2>
            <div className="flex gap-2">
              <input
                type="text"
                onChange={(e) => setInputText(e.target.value)}
                onKeyDown={(e) => activeEnter(e)}
                value={inputText}
                placeholder="ìƒˆë¡œìš´ í• ì¼ì„ ì…ë ¥í•˜ì„¸ìš”..."
                className="flex-1 text-xl md:text-2xl px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
              ></input>
              <button
                onClick={() => {
                  if (!inputText || inputText.trim() === "") {
                    alert("ê°’ì„ ì…ë ¥í•˜ì„¸ìš”!");
                    return;
                  } else {
                    addTodo();
                  }
                }}
                className="bg-blue-400 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium text-xl md:text-2xl transition-colors"
              >
                ì¶”ê°€
              </button>
            </div>
          </div>
        );
      }

      function TodoListSection({
        todos,
        toggleTodo,
        deleteTodo,
        editTodo,
        filteredTodo,
      }) {
        return (
          <div className="border border-blue-200 md:col-span-2 bg-white rounded-lg p-6">
            <h2 className="text-xl md:text-2xl font-semibold text-gray-800 mb-4">
              í• ì¼ ëª©ë¡
            </h2>

            <div id="todoList" className="space-y-2">
              {todos.length === 0 ? (
                <p className="text-gray-600 text-xl md:text-2xl"> í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              ) : (
                <ul>
                  {filteredTodo.map((todo) => (
                    <li key={todo.id}>
                      <div className="flex items-center gap-3 p-3 m-3 bg-gray-50 rounded-lg">
                        <input
                          type="checkbox"
                          checked={todo.completed}
                          onChange={() => toggleTodo(todo.id)}
                          className="w-5 h-5 text-blue-600"
                        ></input>
                        <span
                          className={
                            todo.completed
                              ? "flex-1 text-gray-400 text-2xl line-through"
                              : "flex-1 text-gray-700 text-2xl"
                          }
                        >
                          {todo.text}
                        </span>
                        <button
                          onClick={() => editTodo(todo.id, todo.text)}
                          className="text-blue-500 hover:text-blue-700 px-2 py-1 text-2xl rounded"
                        >
                          ìˆ˜ì •
                        </button>
                        <button
                          onClick={() => deleteTodo(todo.id)}
                          className="text-red-500 hover:text-red-700 px-2 py-1 text-2xl rounded"
                        >
                          ì‚­ì œ
                        </button>
                      </div>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>
        );
      }

      function StatsSection({ total, completed, remaining }) {
        return (
          <div className="border border-blue-200 md:col-span-1 rounded-lg bg-white p-6">
            <h3 className="text-xl md:text-2xl font-semibold text-gray-800 mb-3">
              ì§„í–‰ í˜„í™©
            </h3>
            <div className="grid grid-cols-3 gap-4 text-center">
              <div>
                <div
                  id="totalCount"
                  className="text-4xl font-bold text-blue-400"
                >
                  {total}
                </div>
                <div className="text-xl text-gray-500">ì „ì²´</div>
              </div>
              <div>
                <div
                  id="completedCount"
                  className="text-4xl font-bold text-pink-400"
                >
                  {completed}
                </div>
                <div className="text-xl text-gray-500">ì™„ë£Œ</div>
              </div>
              <div>
                <div
                  id="remainingCount"
                  className="text-4xl font-bold text-yellow-400"
                >
                  {remaining}
                </div>
                <div className="text-xl text-gray-500">ë‚¨ì€ ì¼</div>
              </div>
            </div>
          </div>
        );
      }

      function ButtonsSection({setFilter, completeAll, deleteAll}){
        return (<div className="flex border border-blue-200 bg-white rounded-lg p-6 mb-6">
                <div className="flex-1">
                  <button
                    className="bg-blue-100 text-xl md:text-2xl rounded-lg px-3 py-1 mx-2 hover:bg-blue-300"
                    onClick={() => setFilter("all")}
                  >
                    ì „ì²´
                  </button>
                  <button
                    className="bg-pink-100 text-xl md:text-2xl rounded-lg px-3 py-1 mx-2 hover:bg-pink-300"
                    onClick={() => setFilter("completed")}
                  >
                    ì™„ë£Œ
                  </button>
                  <button
                    className="bg-yellow-100 text-xl md:text-2xl rounded-lg px-3 py-1 mx-2 hover:bg-yellow-200"
                    onClick={() => setFilter("remaining")}
                  >
                    ì§„í–‰ì¤‘
                  </button>
                </div>

                <div className="col-span-1">
                  <button
                    className="bg-gray-200 text-xl md:text-2xl rounded-lg px-3 py-1 mx-2 hover:bg-blue-300"
                    onClick={() => completeAll()}
                  >
                    ì „ì²´ ì™„ë£Œ
                  </button>
                  <button
                    className="bg-gray-200 text-xl md:text-2xl rounded-lg px-3 py-1 mx-2 hover:bg-red-300"
                    onClick={() => deleteAll()}
                  >
                    ì „ì²´ ì‚­ì œ
                  </button>
                </div>
              </div>
            )
      }

      function TodoApp() {
        const [user, setUser] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [todos, setTodos] = React.useState([]);
        const [inputText, setInputText] = React.useState("");

        // ì‚¬ìš©ì í™•ì¸: supabase.auth.getUser()
        React.useEffect(() => {
          checkUser();
        }, []);

        const checkUser = async () => {
          try {
            const { data: { session } } = await supabase.auth.getSession();
            setUser(session?.user || null);
          } catch (error) {
            console.error('âš ï¸ Supabase ì—°ê²° ì‹¤íŒ¨:', error);
            console.error('ğŸ“Œ í•´ê²° ë°©ë²•:');
            console.error('1. Supabase Dashboardì—ì„œ í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸');
            console.error('2. Project URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸');
            console.error('3. í”„ë¡œì íŠ¸ ìƒì„± í›„ 2-3ë¶„ ëŒ€ê¸°');
            // ì„ì‹œë¡œ ì¸ì¦ ì—†ì´ ì§„í–‰ (í…ŒìŠ¤íŠ¸ìš©)
            setUser({ email: 'test@example.com (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)' });
          } finally {
            setLoading(false);
          }
        };

        // ë¡œê·¸ì•„ì›ƒ: supabase.auth.signOut()
        const handleSignOut = async () => {
          const confirmed = confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (confirmed) {
            await supabase.auth.signOut();
            setUser(null);
            setTodos([]);
          }
        };

        const addTodo = async () => {
          if (!inputText || inputText.trim() === "") {
            alert("ê°’ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
          }

          try {
            // Supabaseì— ì§ì ‘ ì‚½ì… (RLSê°€ ìë™ìœ¼ë¡œ user_id ì„¤ì •)
            const { data, error } = await supabase
              .from('todos')
              .insert([{ 
                text: inputText.trim(), 
                completed: false,
                user_id: user.id
              }])
              .select()
              .single();

            if (error) {
              console.error('ì¶”ê°€ ì‹¤íŒ¨:', error);
              alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            } else {
              console.log('âœ… Todo ì¶”ê°€ ì„±ê³µ:', data);
              setTodos([...todos, data]);
              setInputText("");
            }
          } catch (err) {
            console.error('ì¶”ê°€ ì‹¤íŒ¨:', err);
            alert('ì¶”ê°€ ì‹¤íŒ¨');
          }
        };

        // AIë¡œ ìƒì„±ëœ ì—¬ëŸ¬ í• ì¼ì„ í•œë²ˆì— ì¶”ê°€
        const addMultipleTodos = async (todoTexts) => {
          try {
            const todoItems = todoTexts.map(text => ({
              text: text.trim(),
              completed: false,
              user_id: user.id
            }));

            const { data, error } = await supabase
              .from('todos')
              .insert(todoItems)
              .select();

            if (error) {
              console.error('ì¼ê´„ ì¶”ê°€ ì‹¤íŒ¨:', error);
              alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            } else {
              console.log(`âœ… ${data.length}ê°œì˜ Todo ì¶”ê°€ ì„±ê³µ`);
              setTodos([...todos, ...data]);
            }
          } catch (err) {
            console.error('ì¼ê´„ ì¶”ê°€ ì‹¤íŒ¨:', err);
            alert('ì¶”ê°€ ì‹¤íŒ¨');
          }
        };

        const activeEnter = (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
             addTodo();
            }
          };

        const toggleTodo = async (id) => {
          const todo = todos.find(t => t.id === id);
          try {
            // Supabaseì— ì§ì ‘ ì—…ë°ì´íŠ¸ (RLSê°€ ìë™ìœ¼ë¡œ ë³¸ì¸ ë°ì´í„°ë§Œ ìˆ˜ì •)
            const { data, error } = await supabase
              .from('todos')
              .update({ completed: !todo.completed })
              .eq('id', id)
              .select()
              .single();

            if (error) {
              console.error('ìˆ˜ì • ì‹¤íŒ¨:', error);
              alert('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message);
            } else {
              console.log('âœ… Todo ì™„ë£Œ í† ê¸€:', data);
              setTodos(todos.map(t => t.id === id ? data : t));
            }
          } catch (err) {
            console.error('ìˆ˜ì • ì‹¤íŒ¨:', err);
          }
        };

        const deleteTodo = async (id) => {
          try {
            // Supabaseì—ì„œ ì§ì ‘ ì‚­ì œ (RLSê°€ ìë™ìœ¼ë¡œ ë³¸ì¸ ë°ì´í„°ë§Œ ì‚­ì œ)
            const { error } = await supabase
              .from('todos')
              .delete()
              .eq('id', id);

            if (error) {
              console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            } else {
              console.log('âœ… Todo ì‚­ì œ ì„±ê³µ');
              setTodos(todos.filter(t => t.id !== id));
            }
          } catch (err) {
            console.error('ì‚­ì œ ì‹¤íŒ¨:', err);
          }
        };

        const editTodo = async (id, currentText) => {
          const newText = prompt("í• ì¼ì„ ìˆ˜ì •í•˜ì„¸ìš”:", currentText);
          if (newText !== null && newText.trim() !== "") {
            try {
              // Supabaseì— ì§ì ‘ ì—…ë°ì´íŠ¸ (RLSê°€ ìë™ìœ¼ë¡œ ë³¸ì¸ ë°ì´í„°ë§Œ ìˆ˜ì •)
              const { data, error } = await supabase
                .from('todos')
                .update({ text: newText.trim() })
                .eq('id', id)
                .select()
                .single();

              if (error) {
                console.error('ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message);
              } else {
                console.log('âœ… Todo í…ìŠ¤íŠ¸ ìˆ˜ì •:', data);
                setTodos(todos.map(t => t.id === id ? data : t));
              }
            } catch (err) {
              console.error('ìˆ˜ì • ì‹¤íŒ¨:', err);
            }
          }
        };

        const total = todos.length;
        const completed = todos.filter((todo) => todo.completed).length;
        const remaining = total - completed;

        const [filter, setFilter] = React.useState("all");

        const filterTodos = (todo) => {
          if (filter === "all") return true;
          if (filter === "completed") return todo.completed === true;
          if (filter === "remaining") return todo.completed === false;
        };

        const filteredTodo = todos.filter(filterTodos);

        const deleteAll = () => {
          const confirmed = confirm("ëª¨ë“  ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
          if (confirmed) {
            setTodos([]);
          }
        };

        const completeAll = () => {
          const allDone = todos.map((todo) => {
              return { ...todo, completed: true };
            });

          setTodos(allDone);
        };

        React.useEffect(() => {
          // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë§Œ Todo ë¶ˆëŸ¬ì˜¤ê¸°
          if (user && user.id) {
            const fetchTodos = async () => {
              try {
                console.log('ğŸ“‹ ì‚¬ìš©ì Todo ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', user.email);
                // Supabaseì—ì„œ ì§ì ‘ ì¡°íšŒ (RLSê°€ ìë™ìœ¼ë¡œ ë³¸ì¸ ë°ì´í„°ë§Œ í•„í„°ë§)
                const { data, error } = await supabase
                  .from('todos')
                  .select('*')
                  .order('id', { ascending: true });

                if (error) {
                  console.error('âŒ ì¡°íšŒ ì‹¤íŒ¨:', error);
                } else {
                  console.log(`âœ… ${data.length}ê°œì˜ Todo ë¡œë“œ ì™„ë£Œ`);
                  setTodos(data);
                }
              } catch (err) {
                console.error('âŒ ì¡°íšŒ ì‹¤íŒ¨:', err);
              }
            };
            
            fetchTodos();
          }
        }, [user]);

        // ë¡œë”© ì¤‘
        if (loading) {
          return (
            <div className="flex items-center justify-center h-screen">
              <div className="text-3xl text-gray-600 font-[Dongle]">ë¡œë”© ì¤‘...</div>
            </div>
          );
        }

        // ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš°
        if (!user) {
          return (
            <div className="min-h-screen bg-yellow-50 py-10">
              <div className="max-w-5xl mx-auto px-4">
                <header className="text-center mb-8">
                  <h1 className="text-5xl md:text-7xl text-blue-400 mb-4 font-[Dongle]">
                    ì±„ì—°ì˜ To-do List
                  </h1>
                  <p className="text-2xl text-gray-600 font-[Dongle]">ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
                </header>
                <AuthSection onAuthSuccess={(user) => setUser(user)} />
              </div>
            </div>
          );
        }

        // ë¡œê·¸ì¸ ëœ ê²½ìš° - Todo ì•± í‘œì‹œ
        return (
          <>
            <div className="max-w-5xl mx-auto p-10 font-[Dongle]">
              <header className="text-center mb-8">
                <h1 className="text-5xl md:text-7xl text-blue-400 mb-2">
                  ì±„ì—°ì˜ To-do List
                </h1>
                <div className="flex justify-center items-center gap-4">
                  <p className="text-2xl text-gray-600">
                    {user.email}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹
                  </p>
                  <button
                    onClick={handleSignOut}
                    className="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-xl transition-colors"
                  >
                    ë¡œê·¸ì•„ì›ƒ
                  </button>
                </div>
              </header>

              <AIPlanningSection
                onAddMultipleTodos={addMultipleTodos}
              />

              <AddTodoSection
                setInputText={setInputText}
                inputText={inputText}
                addTodo={addTodo}
                activeEnter={activeEnter}
              />

              <ButtonsSection
                setFilter={setFilter}
                completeAll={completeAll}
                deleteAll={deleteAll}
              />

              <div className="flex flex-col md:grid md:grid-cols-3 gap-6">
                <TodoListSection
                  todos={todos}
                  toggleTodo={toggleTodo}
                  deleteTodo={deleteTodo}
                  editTodo={editTodo}
                  filteredTodo={filteredTodo}
                />

                <StatsSection
                  total={total}
                  completed={completed}
                  remaining={remaining}
                />
              </div>
            </div>
          </>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<TodoApp />);
    </script>
  </body>
</html>
